<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado - NOC</title>
    <!-- Importando fontes modernas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ======================================= */
        /*        RESET & CONFIGURA√á√ïES GERAIS     */
        /* ======================================= */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        :root {
            /* Cores e Temas - Corporate Zen (Refinado) */
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #10b981; /* Verde esmeralda mais moderno */
            --accent-hover: #059669;
            --edit: #4b5563;
            --pin: #f59e0b;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --success: #10b981;
            --delete-color: #ef4444;
            --toolbar-bg: #f1f5f9;
            --icon-color: #94a3b8;
            --input-bg: #ffffff;
            --pinned-bg: #fffbeb;
            --pinned-border: #fcd34d;
            --nav-bg: #1e293b;
            --nav-text: #f8fafc;
            
            /* Scrollbar vars */
            --scroll-track: transparent;
            --scroll-thumb: #cbd5e1;
            --scroll-thumb-hover: #94a3b8;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --primary: #e2e8f0;
            --primary-light: #cbd5e1;
            --accent: #10b981;
            --accent-hover: #34d399;
            --edit: #94a3b8;
            --pin: #fbbf24;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --toolbar-bg: #0f172a;
            --icon-color: #64748b;
            --input-bg: #0f172a;
            --pinned-bg: #322a10;
            --pinned-border: #b45309;
            --nav-bg: #020617;

            --scroll-thumb: #475569;
            --scroll-thumb-hover: #64748b;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        /* Scrollbar Melhorada */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scroll-thumb-hover); border: 2px solid transparent; background-clip: content-box; }

        /* ======================================= */
        /*              NAVEGA√á√ÉO                  */
        /* ======================================= */
        .main-nav {
            background-color: var(--nav-bg);
            padding: 0 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2000;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .nav-container {
            display: flex;
            gap: 0.5rem;
            max-width: 1200px;
            width: 100%;
            overflow-x: auto;
            padding: 0.5rem 0;
        }

        .nav-item {
            background: transparent;
            border: none;
            padding: 0.75rem 1.25rem;
            color: var(--nav-text);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            opacity: 0.7;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover { opacity: 1; background: rgba(255,255,255,0.08); }
        .nav-item.active { opacity: 1; background: rgba(255,255,255,0.15); color: #fff; font-weight: 600; box-shadow: 0 0 0 1px rgba(255,255,255,0.1); }
        
        /* Ajuste para √≠cones no nav */
        .nav-icon { font-size: 1.1em; }

        /* ======================================= */
        /*              CONTE√öDO                   */
        /* ======================================= */
        .tab-content {
            display: none;
            padding: 2rem 1rem;
            width: 100%;
            max-width: 1400px; /* Largura um pouco menor para leitura melhor */
            margin: 0 auto;
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 2rem;
            font-size: 2rem;
            text-align: center;
            letter-spacing: -0.02em;
        }

        /* ======================================= */
        /*          BOT√ïES E CONTROLES             */
        /* ======================================= */
        /* Bot√µes Flutuantes (Tema/Bg) */
        .floating-btn {
            position: fixed;
            right: 1.5rem;
            width: 3rem;
            height: 3rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
        }
        .dark-mode-toggle { bottom: 1.5rem; }
        .bg-image-toggle { bottom: 5.5rem; }
        .floating-btn:hover { transform: scale(1.1); box-shadow: 0 12px 20px -8px rgba(0,0,0,0.3); }

        /* Bot√µes Padr√£o */
        button, .btn { font-family: inherit; }
        
        .backup-area { display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center; flex-wrap: wrap; }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--primary);
            background-color: var(--card-bg);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .btn-outline:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .add-btn {
            width: 100%;
            padding: 1rem;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        .add-btn:hover { background-color: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4); }
        .add-btn:active { transform: translateY(0); }

        /* ======================================= */
        /*              INPUTS & FORMS             */
        /* ======================================= */
        .input-container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 800px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--accent);
        }

        input[type="text"], input[type="search"], input[type="date"], input[type="number"], select, textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        /* Editor Rico */
        .editor-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            background-color: var(--input-bg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .toolbar {
            background-color: var(--toolbar-bg);
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        .toolbar button {
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            padding: 0.4rem 0.6rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border-radius: 4px;
            transition: all 0.1s;
        }
        .toolbar button:hover { background: rgba(0,0,0,0.05); color: var(--primary); border-color: rgba(0,0,0,0.1); }

        .rich-editor {
            width: 100%;
            min-height: 200px;
            padding: 1.5rem;
            outline: none;
            font-size: 1rem;
            line-height: 1.7;
            background-color: var(--input-bg);
            color: var(--text);
            overflow-y: auto;
            max-height: 600px;
        }
        .rich-editor img {
            max-width: 100%;
            border-radius: 6px;
            margin: 1rem 0;
            box-shadow: var(--shadow-sm);
            transition: 0.2s;
            cursor: pointer;
        }
        .rich-editor img:hover { box-shadow: var(--shadow-lg); }

        /* ======================================= */
        /*              CARDS & GRIDS              */
        /* ======================================= */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            width: 100%;
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            max-width: 900px;
        }

        /* Card Prompt */
        .card-prompt {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-color);
            border-top: 4px solid transparent;
            height: 400px;
        }
        .card-prompt:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: transparent; }
        .card-prompt.is-pinned {
            background-color: var(--pinned-bg);
            border-color: var(--pinned-border);
            border-top-color: var(--pinned-border);
            order: -1;
        }
        
        .card-prompt h3 {
            margin: 0 0 1rem 0;
            color: var(--primary);
            font-size: 1.15rem;
            font-weight: 600;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            padding-right: 4rem; /* Espa√ßo para bot√µes topo */
            line-height: 1.4;
        }
        
        .card-prompt .card-content {
            font-size: 0.95rem;
            color: var(--text-secondary);
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
            white-space: pre-wrap;
        }
        /* Scrollbar fina para o conte√∫do do card */
        .card-prompt .card-content::-webkit-scrollbar { width: 4px; }
        .card-prompt .card-content::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 2px; }

        .top-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.25rem;
        }
        .btn-top-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 1rem;
            color: var(--icon-color);
            opacity: 0.6;
            transition: 0.2s;
        }
        .btn-top-icon:hover { opacity: 1; background: rgba(0,0,0,0.05); color: var(--primary); }

        .card-actions { display: flex; gap: 0.75rem; margin-top: auto; }
        .btn-action {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .btn-copy { background-color: rgba(16, 185, 129, 0.1); color: var(--accent-hover); }
        .btn-copy:hover { background-color: var(--accent); color: white; }
        .btn-copy.copied { background-color: var(--success); color: white; }
        
        .btn-edit { background-color: rgba(75, 85, 99, 0.1); color: var(--edit); }
        .btn-edit:hover { background-color: var(--edit); color: white; }

        /* Card Tutorial */
        .card-tutorial {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--accent);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .card-tutorial:hover { box-shadow: var(--shadow-md); }
        .card-tutorial.is-pinned { background-color: var(--pinned-bg); border-color: var(--pinned-border); }

        .card-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }
        .card-header:hover { background-color: rgba(0,0,0,0.02); }
        
        .card-title-area h3 { margin: 0; font-size: 1.15rem; color: var(--primary); font-weight: 600; }
        
        .card-tags { display: flex; gap: 6px; margin-right: 1rem; flex-wrap: wrap; }
        .card-tag-small {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 99px;
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .card-body { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0, 1, 0, 1); opacity: 0; }
        .card-tutorial.open .card-body { max-height: 5000px; border-top: 1px solid var(--border-color); opacity: 1; transition: max-height 0.6s ease-in-out, opacity 0.3s ease; }
        
        .card-content-inner { padding: 2rem; line-height: 1.8; color: var(--text); font-size: 1rem; }
        .card-footer { padding: 1rem 2rem 1.5rem; display: flex; justify-content: flex-end; border-top: 1px solid rgba(0,0,0,0.05); }

        /* Card Command (Terminal Style) */
        .card-command {
            background: #0f172a;
            color: #e2e8f0;
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            height: 340px;
            border: 1px solid #334155;
            position: relative;
        }
        .card-command h3 { color: #38bdf8; margin: 0 0 1rem 0; font-family: 'Inter', sans-serif; font-size: 1.1rem; border-bottom: 1px solid #1e293b; padding-bottom: 0.75rem; }
        
        .terminal-area {
            background: #020617;
            color: #4ade80;
            font-family: 'Fira Code', 'Consolas', monospace;
            padding: 1rem;
            border-radius: 6px;
            flex: 1;
            overflow: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid #1e293b;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .terminal-line { margin-bottom: 0.5rem; white-space: pre-wrap; word-break: break-all; }
        .terminal-prompt { color: #f472b6; margin-right: 8px; user-select: none; }
        
        .command-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .btn-terminal {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #334155;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            background: #1e293b;
            color: #e2e8f0;
            transition: all 0.2s;
        }
        .btn-terminal:hover { background: #334155; border-color: #475569; }
        .btn-terminal.copy { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border-color: rgba(16, 185, 129, 0.3); }
        .btn-terminal.copy:hover { background: rgba(16, 185, 129, 0.3); }

        /* ======================================= */
        /*              MODAIS E COMPONENTES       */
        /* ======================================= */
        /* Tag Manager */
        .tags-manager-section {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--toolbar-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .tag-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .tag-chip.selected { opacity: 1; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 3500;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            border-top: 5px solid var(--accent);
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* NOC Module Styles (Atualizados) */
        .noc-module-wrapper { display: flex; gap: 1.5rem; width: 100%; align-items: flex-start; }
        .noc-sidebar, .noc-main-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .noc-sidebar { width: 320px; flex-shrink: 0; }
        .noc-main-content { flex: 1; }
        
        .noc-routine-item {
            background: var(--toolbar-bg);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .status-0 { border-left: 4px solid #10b981; }
        .status-1 { border-left: 4px solid #f59e0b; }
        .status-err { border-left: 4px solid #ef4444; }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .noc-module-wrapper { flex-direction: column; }
            .noc-sidebar { width: 100%; }
            .main-nav { padding: 0.5rem; }
            .nav-item { padding: 0.5rem 1rem; font-size: 0.85rem; }
            #commandsGrid { grid-template-columns: 1fr; }
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 1rem;
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4000;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 3rem; }
    </style>
</head>
<body>

    <!-- Navega√ß√£o Principal -->
    <nav class="main-nav">
        <div class="nav-container">
            <button class="nav-item active" onclick="AppManager.switchTab('prompts', event)" role="tab" aria-selected="true">
                <span class="nav-icon">üöÄ</span> Prompts
            </button>
            <button class="nav-item" onclick="AppManager.switchTab('tutorials', event)" role="tab" aria-selected="false">
                <span class="nav-icon">üìö</span> KBs & Procedimentos
            </button>
            <button class="nav-item" onclick="AppManager.switchTab('commands', event)" role="tab" aria-selected="false">
                <span class="nav-icon">üîß</span> Comandos
            </button>
            <button class="nav-item" onclick="AppManager.switchTab('reports', event)" role="tab" aria-selected="false">
                <span class="nav-icon">üìã</span> Relat√≥rios
            </button>
        </div>
    </nav>

    <!-- Bot√µes Flutuantes -->
    <button class="floating-btn bg-image-toggle" onclick="AppManager.triggerBgUpload()" title="Alterar plano de fundo" aria-label="Alterar plano de fundo">
        <span>üñºÔ∏è</span>
    </button>
    <input type="file" id="bgBodyInput" accept="image/*" style="display: none;" onchange="AppManager.handleBgUpload(this)">

    <button class="floating-btn dark-mode-toggle" onclick="AppManager.toggleDarkMode()" title="Alternar tema" aria-label="Alternar modo escuro">
        <span id="modeIcon">üåô</span>
    </button>

    <!-- Lightbox (Imagem Fullscreen) -->
    <div id="lightbox" class="modal-overlay" onclick="this.classList.remove('active')" role="dialog" aria-hidden="true">
        <img id="lightboxImg" style="max-width: 95%; max-height: 95%; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.8);" alt="Imagem ampliada">
    </div>
    
    <!-- Modal Tags -->
    <div id="tagModal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-content">
            <h2>Criar Nova Tag</h2>
            <input type="text" id="tagModalName" placeholder="Nome da tag (ex: Banco de Dados)...">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <label>Cor:</label>
                <input type="color" id="tagModalColor" value="#10b981" style="width: 50px; height: 40px; padding: 2px;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn-outline" onclick="TutorialsManager.closeTagModal()">Cancelar</button>
                <button class="add-btn" style="width: auto;" onclick="TutorialsManager.createTagFromModal()">Criar</button>
            </div>
        </div>
    </div>
    
    <div id="dbStatus" style="position: fixed; bottom: 10px; left: 10px; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.5;">Inicializando...</div>

    <!-- ============================================ -->
    <!--                 TAB: PROMPTS                 -->
    <!-- ============================================ -->
    <div id="tab-prompts" class="tab-content active">
        <h1>Gerenciador de Prompts</h1>
        
        <div class="backup-area">
            <button class="btn-outline" onclick="PromptsManager.export()">üíæ Backup</button>
            <button class="btn-outline" onclick="document.getElementById('promptImport').click()">üìÇ Restaurar</button>
            <input type="file" id="promptImport" accept=".json" style="display: none;" onchange="PromptsManager.import(this)">
        </div>

        <div class="input-container">
            <input type="search" id="promptSearch" placeholder="üîç Pesquisar prompts..." onkeyup="PromptsManager.render()">
            <input type="text" id="promptTitleInput" placeholder="T√≠tulo do Prompt...">
            
            <div class="editor-container">
                <div class="toolbar">
                    <button onclick="AppManager.formatText('bold')" title="Negrito"><b>B</b></button>
                    <button onclick="AppManager.formatText('italic')" title="It√°lico"><i>I</i></button>
                    <button onclick="AppManager.formatText('underline')" title="Sublinhado"><u>U</u></button>
                    <div style="width: 1px; background: var(--border-color); margin: 0 5px;"></div>
                    <button onclick="AppManager.formatText('insertUnorderedList')" title="Lista">‚Ä¢ Lista</button>
                    <button onclick="AppManager.formatText('insertOrderedList')" title="Lista Numerada">1. Lista</button>
                </div>
                <div id="promptTextInput" class="rich-editor" contenteditable="true" placeholder="Escreva seu prompt aqui..."></div>
            </div>
            <button class="add-btn" id="promptSaveButton" onclick="PromptsManager.add()">Salvar Prompt</button>
        </div>

        <div class="items-grid" id="promptGrid"></div>
    </div>

    <!-- ============================================ -->
    <!--             TAB: TUTORIAIS (KBs)             -->
    <!-- ============================================ -->
    <div id="tab-tutorials" class="tab-content">
        <h1>KBs & Procedimentos</h1>

        <div class="backup-area">
            <button class="btn-outline" onclick="TutorialsManager.export()">üíæ Backup</button>
            <button class="btn-outline" onclick="document.getElementById('tutorialImport').click()">üìÇ Restaurar</button>
            <input type="file" id="tutorialImport" accept=".json" style="display: none;" onchange="TutorialsManager.import(this)">
        </div>

        <div class="input-container" id="tutorialInputContainer">
            <input type="search" id="tutorialSearch" placeholder="üîç Pesquisar tutoriais..." onkeyup="TutorialsManager.render()">
            <input type="text" id="tutorialTitleInput" placeholder="T√≠tulo do Procedimento...">
            
            <div class="tags-manager-section">
                <div id="tagsSelectionArea" style="display: flex; flex-wrap: wrap; margin-bottom: 10px;"></div>
                <button class="btn-outline" style="font-size: 0.8rem;" onclick="TutorialsManager.openTagModal()">+ Nova Tag</button>
            </div>

            <div class="editor-container">
                <div class="toolbar">
                    <button onclick="AppManager.formatText('bold')"><b>B</b></button>
                    <button onclick="AppManager.formatText('italic')"><i>I</i></button>
                    <button onclick="AppManager.formatText('insertUnorderedList')">‚Ä¢ Lista</button>
                    <button onclick="TutorialsManager.triggerImageUpload()">üñºÔ∏è Upload Imagem</button>
                    <button onclick="TutorialsManager.triggerUrlImage()">üîó Link Imagem</button>
                    <input type="file" id="imgUpload" accept="image/*" style="display: none;" onchange="TutorialsManager.handleImageUpload(this)">
                </div>
                <div id="tutorialTextInput" class="rich-editor" contenteditable="true" placeholder="Descreva o procedimento..."></div>
            </div>
            <button class="add-btn" id="tutorialSaveButton" onclick="TutorialsManager.add()">Salvar Procedimento</button>
        </div>

        <div class="items-list" id="tutorialGrid"></div>
    </div>

    <!-- ============================================ -->
    <!--               TAB: COMANDOS                  -->
    <!-- ============================================ -->
    <div id="tab-commands" class="tab-content">
        <h1>Biblioteca de Comandos</h1>

        <div class="backup-area">
            <button class="btn-outline" onclick="CommandsManager.export()">üíæ Backup</button>
            <button class="btn-outline" onclick="document.getElementById('commandsImport').click()">üìÇ Restaurar</button>
            <input type="file" id="commandsImport" accept=".json" style="display: none;" onchange="CommandsManager.import(this)">
        </div>

        <div class="input-container">
            <input type="search" id="commandSearch" placeholder="üîç Pesquisar comandos..." onkeyup="CommandsManager.render()">
            <input type="text" id="commandTitleInput" placeholder="T√≠tulo do Comando...">
            
            <div class="editor-container">
                <div class="toolbar"><button onclick="AppManager.formatText('bold')"><b>B</b></button></div>
                <div id="commandTextInput" class="rich-editor" contenteditable="true" placeholder="Cole o comando aqui..." style="font-family: 'Fira Code', monospace; font-size: 0.9rem;"></div>
            </div>
            <button class="add-btn" id="commandSaveButton" onclick="CommandsManager.add()">Salvar Comando</button>
        </div>

        <div class="items-grid" id="commandsGrid"></div>
    </div>

    <!-- ============================================ -->
    <!--               TAB: RELAT√ìRIOS                -->
    <!-- ============================================ -->
    <div id="tab-reports" class="tab-content">
        <h1>Relat√≥rios de Backup</h1>
        
        <div class="noc-module-wrapper">
            <!-- Sidebar Config -->
            <div class="noc-sidebar">
                <h3 style="margin-top:0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">1. Configura√ß√£o</h3>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Cliente:</label>
                <select id="nocClientSelect" onchange="ReportsManager.handleClientChange()"></select>
                
                <div style="display: flex; gap: 5px; margin-bottom: 1rem;">
                    <input type="text" id="nocNewClientName" placeholder="Novo Cliente" style="margin-bottom: 0;">
                    <button class="add-btn" onclick="ReportsManager.addClient()" style="width: auto; padding: 0 1rem;">+</button>
                </div>

                <div style="background: var(--toolbar-bg); padding: 10px; border-radius: 6px; margin-top: 20px;">
                    <h4 style="margin: 0 0 10px 0;">Nova Rotina</h4>
                    <input type="text" id="nocRoutineNum" placeholder="N¬∫ (Ex: 1)">
                    <input type="text" id="nocRoutineName" placeholder="Descri√ß√£o">
                    <button onclick="ReportsManager.addRoutine()" class="btn-outline" style="width: 100%; justify-content: center;">Adicionar</button>
                </div>

                <div style="margin-top: 15px;">
                    <label style="font-weight:bold; font-size: 0.85rem;">Ordenar por:</label>
                    <div class="noc-view-options" style="display: flex; gap: 5px; margin-top: 5px;">
                        <button id="btnSortManual" class="btn-outline active" style="font-size: 0.75rem; padding: 4px 8px;" onclick="ReportsManager.setSortMode('manual')">Manual</button>
                        <button id="btnSortAlpha" class="btn-outline" style="font-size: 0.75rem; padding: 4px 8px;" onclick="ReportsManager.setSortMode('alpha')">A-Z</button>
                    </div>
                </div>

                <div id="nocSavedRoutinesList" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color); display: flex; gap: 5px;">
                     <button onclick="ReportsManager.exportData()" class="btn-outline" style="font-size: 0.75rem; flex: 1;">Exportar</button>
                     <button onclick="document.getElementById('nocImportFile').click()" class="btn-outline" style="font-size: 0.75rem; flex: 1;">Importar</button>
                     <input type="file" id="nocImportFile" style="display: none;" accept=".json" onchange="ReportsManager.importData(event)">
                </div>
            </div>

            <!-- Main Content -->
            <div class="noc-main-content">
                <h3 style="margin-top:0;">2. Preenchimento Di√°rio</h3>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label>Data Inicial:</label>
                        <input type="date" id="reportDateStart" onchange="ReportsManager.clearOutput()">
                    </div>
                    <div style="flex: 1;">
                        <label>Data Final:</label>
                        <input type="date" id="reportDateEnd" onchange="ReportsManager.clearOutput()">
                    </div>
                </div>
                
                <div id="nocDailyEntryArea" style="min-height: 100px; background: var(--toolbar-bg); border-radius: 8px; padding: 15px;">
                    <p style="text-align: center; color: var(--text-secondary);">Selecione um cliente para carregar as rotinas.</p>
                </div>
                
                <button class="add-btn" style="margin-top: 20px;" onclick="ReportsManager.generateReport()">Gerar Relat√≥rio</button>
                
                <h3 style="margin-top: 30px;">3. Resultado Final</h3>
                <textarea id="nocOutputArea" style="height: 150px; font-family: monospace;" readonly placeholder="O relat√≥rio aparecer√° aqui..."></textarea>
                <div class="card-actions">
                    <button onclick="ReportsManager.copyText()" class="add-btn" style="background-color: var(--success);">Copiar Texto</button>
                    <button onclick="ReportsManager.enableEdit()" class="btn-outline">Editar Manualmente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" role="alert">Sucesso!</div>

    <!-- SCRIPT ORIGINAL (Preservado para manter l√≥gica funcional) -->
    <script>
        const CONFIG = {
            STORAGE_KEY_PROMPTS: 'myPrompts',
            STORAGE_KEY_COMMANDS: 'myCommands',
            STORAGE_KEY_DARK_MODE: 'kb_darkMode',
            STORAGE_KEY_BG: 'kb_background_image',
            DB_NAME: 'KB_Database_Integrated',
            DB_STORE: 'tutorials',
            TAGS_KEY: 'KB_Tags_Integrated',
            MAX_BG_SIZE_BYTES: 1.5 * 1024 * 1024,
        };

        const SecurityUtils = {
            sanitizeText(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            isValidURL(url) {
                try { new URL(url); return true; } catch { return false; }
            },
            isValidCSSValue(value) {
                return /^(\d+(\.\d+)?(px|%|em|rem|vh|vw))$/.test(value);
            }
        };

        const AppManager = {
            currentTab: 'prompts',
            switchTab(tabId, e) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    item.setAttribute('aria-selected', 'false');
                });
                document.getElementById('tab-' + tabId).classList.add('active');
                if (e && e.currentTarget) {
                    e.currentTarget.classList.add('active');
                    e.currentTarget.setAttribute('aria-selected', 'true');
                }
                this.currentTab = tabId;
                if (tabId === 'prompts') PromptsManager.render();
                if (tabId === 'tutorials') TutorialsManager.render();
                if (tabId === 'commands') CommandsManager.render();
                if (tabId === 'reports') ReportsManager.init();
            },
            toggleDarkMode() {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem(CONFIG.STORAGE_KEY_DARK_MODE, isDark ? 'enabled' : 'disabled');
                document.getElementById('modeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            },
            showToast(msg) {
                const t = document.getElementById("toast");
                t.textContent = msg || "Sucesso!";
                t.classList.add("show");
                setTimeout(() => t.classList.remove("show"), 2500);
            },
            formatText(cmd) {
                document.execCommand(cmd, false, null);
                const activeEditor = document.querySelector('.tab-content.active .rich-editor');
                if(activeEditor) activeEditor.focus();
            },
            triggerBgUpload() { document.getElementById('bgBodyInput').click(); },
            handleBgUpload(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    if (file.size > CONFIG.MAX_BG_SIZE_BYTES) {
                        AppManager.showToast('Imagem muito grande (> 1.5MB).');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        document.body.style.backgroundImage = `url('${imageData}')`;
                        try { localStorage.setItem(CONFIG.STORAGE_KEY_BG, imageData); AppManager.showToast('Plano de fundo salvo!'); }
                        catch (err) { AppManager.showToast('Erro: Espa√ßo cheio!'); }
                    };
                    reader.readAsDataURL(file);
                }
            },
            loadBackground() {
                try { const bg = localStorage.getItem(CONFIG.STORAGE_KEY_BG); if (bg) document.body.style.backgroundImage = `url('${bg}')`; } catch(e){}
            }
        };

        const PromptsManager = {
            editingId: null,
            getFromStorage() { try { return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY_PROMPTS)) || []; } catch { return []; } },
            saveToStorage(prompts) { localStorage.setItem(CONFIG.STORAGE_KEY_PROMPTS, JSON.stringify(prompts)); },
            add() {
                const title = document.getElementById('promptTitleInput').value.trim();
                const text = document.getElementById('promptTextInput').innerHTML;
                if (!title || !text) return AppManager.showToast("Preencha t√≠tulo e conte√∫do.");
                let prompts = this.getFromStorage();
                if (this.editingId) prompts = prompts.map(p => p.id === this.editingId ? { ...p, title, text } : p);
                else prompts.push({ id: Date.now(), title, text, isPinned: false });
                this.saveToStorage(prompts);
                this.resetForm();
                this.render();
                AppManager.showToast("Prompt salvo!");
            },
            resetForm() {
                document.getElementById('promptTitleInput').value = '';
                document.getElementById('promptTextInput').innerHTML = '';
                this.editingId = null;
                document.getElementById('promptSaveButton').textContent = 'Salvar Prompt';
            },
            edit(id) {
                const p = this.getFromStorage().find(x => x.id === id);
                if (!p) return;
                this.editingId = id;
                document.getElementById('promptTitleInput').value = p.title;
                document.getElementById('promptTextInput').innerHTML = p.text;
                document.getElementById('promptSaveButton').textContent = 'Atualizar Prompt';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            delete(id) {
                if (!confirm("Apagar prompt?")) return;
                let prompts = this.getFromStorage().filter(p => p.id !== id);
                this.saveToStorage(prompts);
                this.render();
            },
            togglePin(id) {
                let prompts = this.getFromStorage().map(p => p.id === id ? { ...p, isPinned: !p.isPinned } : p);
                this.saveToStorage(prompts);
                this.render();
            },
            async copy(btn, id) {
                const p = this.getFromStorage().find(x => x.id === id);
                if (!p) return;
                
                try {
                    // Tenta usar a Clipboard API moderna com HTML e Texto para preservar formata√ß√£o
                    const blobHtml = new Blob([p.text], { type: 'text/html' });
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = p.text;
                    const textToCopy = tempDiv.innerText || tempDiv.textContent;
                    const blobText = new Blob([textToCopy], { type: 'text/plain' });
                    
                    await navigator.clipboard.write([
                        new ClipboardItem({ 
                            'text/html': blobHtml, 
                            'text/plain': blobText 
                        })
                    ]);
                } catch (err) {
                    console.error("Clipboard API falhou, tentando fallback...", err);
                    // Fallback robusto para formata√ß√£o usando sele√ß√£o de elemento
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = p.text;
                    tempDiv.style.position = "fixed";
                    tempDiv.style.left = "-9999px";
                    tempDiv.style.top = "0";
                    document.body.appendChild(tempDiv);
                    
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(tempDiv);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    try {
                        document.execCommand('copy');
                    } catch (e) {
                        console.error("Fallback falhou", e);
                        // √öltimo recurso: apenas texto
                        const plainText = tempDiv.innerText || tempDiv.textContent;
                        navigator.clipboard.writeText(plainText);
                    }
                    
                    selection.removeAllRanges();
                    document.body.removeChild(tempDiv);
                }

                const originalText = btn.textContent;
                btn.textContent = "Copiado!";
                btn.classList.add("copied");
                setTimeout(() => { btn.textContent = originalText; btn.classList.remove("copied"); }, 1500);
            },
            render() {
                const grid = document.getElementById('promptGrid');
                const search = document.getElementById('promptSearch').value.toLowerCase();
                let prompts = this.getFromStorage();
                if (search) prompts = prompts.filter(p => p.title.toLowerCase().includes(search) || p.text.toLowerCase().includes(search));
                prompts.sort((a, b) => (b.isPinned - a.isPinned) || a.title.localeCompare(b.title));
                grid.innerHTML = '';
                if (prompts.length === 0) { grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; opacity: 0.5;">Nenhum prompt encontrado.</p>'; return; }
                prompts.forEach(p => {
                    const card = document.createElement('div');
                    card.className = `card-prompt ${p.isPinned ? 'is-pinned' : ''}`;
                    card.innerHTML = `
                        <div class="top-actions">
                            <button class="btn-top-icon" onclick="PromptsManager.togglePin(${p.id})">${p.isPinned ? 'üìå' : 'üìç'}</button>
                            <button class="btn-top-icon" onclick="PromptsManager.delete(${p.id})">üóëÔ∏è</button>
                        </div>
                        <h3>${SecurityUtils.sanitizeText(p.title)}</h3>
                        <div class="card-content">${p.text}</div>
                        <div class="card-actions">
                            <button class="btn-action btn-copy" onclick="PromptsManager.copy(this, ${p.id})">Copiar Texto</button>
                            <button class="btn-action btn-edit" onclick="PromptsManager.edit(${p.id})">Editar</button>
                        </div>`;
                    grid.appendChild(card);
                });
            },
            export() {
                const blob = new Blob([JSON.stringify(this.getFromStorage(), null, 2)], { type: "application/json" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_prompts.json`; a.click();
            },
            import(input) {
                const reader = new FileReader();
                reader.onload = e => { try { const imp = JSON.parse(e.target.result); if(Array.isArray(imp)){ this.saveToStorage(imp); this.render(); AppManager.showToast("Importado!"); } } catch { alert("Arquivo inv√°lido."); } };
                if(input.files[0]) reader.readAsText(input.files[0]);
            }
        };

        const CommandsManager = {
            editingId: null,
            getFromStorage() { try { return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY_COMMANDS)) || []; } catch { return []; } },
            saveToStorage(cmds) { localStorage.setItem(CONFIG.STORAGE_KEY_COMMANDS, JSON.stringify(cmds)); },
            add() {
                const title = document.getElementById('commandTitleInput').value.trim();
                const text = document.getElementById('commandTextInput').innerHTML;
                if (!title || !text) return AppManager.showToast("Preencha campos.");
                let cmds = this.getFromStorage();
                if (this.editingId) cmds = cmds.map(p => p.id === this.editingId ? { ...p, title, text } : p);
                else cmds.push({ id: Date.now(), title, text, isPinned: false });
                this.saveToStorage(cmds);
                this.resetForm();
                this.render();
                AppManager.showToast("Comando salvo!");
            },
            resetForm() {
                document.getElementById('commandTitleInput').value = '';
                document.getElementById('commandTextInput').innerHTML = '';
                this.editingId = null;
                document.getElementById('commandSaveButton').textContent = 'Salvar Comando';
            },
            edit(id) {
                const p = this.getFromStorage().find(x => x.id === id);
                if (!p) return;
                this.editingId = id;
                document.getElementById('commandTitleInput').value = p.title;
                document.getElementById('commandTextInput').innerHTML = p.text;
                document.getElementById('commandSaveButton').textContent = 'Atualizar Comando';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            delete(id) {
                if (!confirm("Apagar comando?")) return;
                let cmds = this.getFromStorage().filter(p => p.id !== id);
                this.saveToStorage(cmds);
                this.render();
            },
            togglePin(id) {
                let cmds = this.getFromStorage().map(p => p.id === id ? { ...p, isPinned: !p.isPinned } : p);
                this.saveToStorage(cmds);
                this.render();
            },
            async copy(btn, id) {
                const p = this.getFromStorage().find(x => x.id === id);
                if (!p) return;
                
                try {
                    // Tenta usar a Clipboard API moderna com HTML e Texto
                    const blobHtml = new Blob([p.text], { type: 'text/html' });
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = p.text;
                    const textToCopy = tempDiv.innerText || tempDiv.textContent;
                    const blobText = new Blob([textToCopy], { type: 'text/plain' });
                    
                    await navigator.clipboard.write([
                        new ClipboardItem({ 
                            'text/html': blobHtml, 
                            'text/plain': blobText 
                        })
                    ]);
                } catch (err) {
                    console.error("Clipboard API falhou, tentando fallback...", err);
                    // Fallback robusto para formata√ß√£o usando sele√ß√£o de elemento
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = p.text;
                    tempDiv.style.position = "fixed";
                    tempDiv.style.left = "-9999px";
                    tempDiv.style.top = "0";
                    document.body.appendChild(tempDiv);
                    
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(tempDiv);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    try {
                        document.execCommand('copy');
                    } catch (e) {
                        console.error("Fallback falhou", e);
                        // √öltimo recurso: apenas texto
                        const plainText = tempDiv.innerText || tempDiv.textContent;
                        navigator.clipboard.writeText(plainText);
                    }
                    
                    selection.removeAllRanges();
                    document.body.removeChild(tempDiv);
                }

                const originalText = btn.textContent; 
                btn.textContent = "Copiado!";
                btn.classList.add("copied");
                setTimeout(() => { btn.textContent = originalText; btn.classList.remove("copied"); }, 1500);
            },
            render() {
                const grid = document.getElementById('commandsGrid');
                const search = document.getElementById('commandSearch').value.toLowerCase();
                let cmds = this.getFromStorage();
                if (search) cmds = cmds.filter(p => p.title.toLowerCase().includes(search) || p.text.toLowerCase().includes(search));
                cmds.sort((a, b) => (b.isPinned - a.isPinned) || a.title.localeCompare(b.title));
                grid.innerHTML = '';
                if (cmds.length === 0) { grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; opacity: 0.5;">Nenhum comando encontrado.</p>'; return; }
                cmds.forEach(p => {
                    const card = document.createElement('div');
                    card.className = `card-command`;
                    const temp = document.createElement('div'); temp.innerHTML = p.text;
                    const lines = (temp.innerText || temp.textContent || '').split(/\r?\n/).filter(Boolean);
                    let terminalHtml = lines.length === 0 ? '<div class="terminal-line"><span class="terminal-prompt">$</span> <span>...</span></div>' : lines.map((ln, idx) => `<div class="terminal-line"><span class="terminal-prompt">${idx===0 ? '$' : '>'}</span>${SecurityUtils.sanitizeText(ln)}</div>`).join('');
                    card.innerHTML = `<h3>${SecurityUtils.sanitizeText(p.title)}</h3><div class="terminal-area">${terminalHtml}</div><div class="command-actions"><button class="btn-terminal copy" onclick="CommandsManager.copy(this, ${p.id})">Copiar</button><button class="btn-terminal" onclick="CommandsManager.edit(${p.id})">Editar</button><button class="btn-terminal" onclick="CommandsManager.togglePin(${p.id})">${p.isPinned ? 'üìå' : 'üìç'}</button><button class="btn-terminal" onclick="CommandsManager.delete(${p.id})">üóëÔ∏è</button></div>`;
                    grid.appendChild(card);
                });
            },
            export() { const blob = new Blob([JSON.stringify(this.getFromStorage(), null, 2)], { type: "application/json" }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_comandos.json`; a.click(); },
            import(input) { const reader = new FileReader(); reader.onload = e => { try { const imp = JSON.parse(e.target.result); if(Array.isArray(imp)){ this.saveToStorage(imp); this.render(); AppManager.showToast("Importado!"); } } catch { alert("Erro import."); } }; if(input.files[0]) reader.readAsText(input.files[0]); }
        };

        const TutorialsManager = {
            db: null, editingId: null, selectedTagIds: [],
            async initDB() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(CONFIG.DB_NAME, 1);
                    req.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains(CONFIG.DB_STORE)) db.createObjectStore(CONFIG.DB_STORE, { keyPath: "id" }); };
                    req.onsuccess = e => { this.db = e.target.result; document.getElementById('dbStatus').textContent = "üü¢ DB Online"; resolve(); };
                });
            },
            async dbSave(item) { return new Promise((resolve) => { const tx = this.db.transaction(CONFIG.DB_STORE, "readwrite"); tx.objectStore(CONFIG.DB_STORE).put(item); tx.oncomplete = () => resolve(); }); },
            async dbGetAll() { return new Promise((resolve) => { const tx = this.db.transaction(CONFIG.DB_STORE, "readonly"); const req = tx.objectStore(CONFIG.DB_STORE).getAll(); req.onsuccess = e => resolve(e.target.result || []); }); },
            getTags() { try { const tags = JSON.parse(localStorage.getItem(CONFIG.TAGS_KEY)); return Array.isArray(tags) ? tags : []; } catch { return []; } },
            saveTags(tags) { localStorage.setItem(CONFIG.TAGS_KEY, JSON.stringify(tags)); },
            openTagModal() { document.getElementById('tagModal').classList.add('active'); document.getElementById('tagModalName').focus(); },
            closeTagModal() { document.getElementById('tagModal').classList.remove('active'); },
            createTagFromModal() {
                const name = document.getElementById('tagModalName').value.trim(); const color = document.getElementById('tagModalColor').value;
                if (!name) return;
                const tags = this.getTags(); tags.push({ id: 'tag_' + Date.now(), name, color });
                this.saveTags(tags); this.closeTagModal(); this.renderTagsSelection();
            },
            deleteTag(e, id) { if(e && e.stopPropagation) e.stopPropagation(); if (!confirm("Excluir tag?")) return; const tags = this.getTags().filter(t => t.id !== id); this.saveTags(tags); this.selectedTagIds = this.selectedTagIds.filter(tid => tid !== id); this.renderTagsSelection(); },
            renderTagsSelection() {
                const div = document.getElementById('tagsSelectionArea'); if (!div) return; div.innerHTML = '';
                const tags = this.getTags() || [];
                tags.forEach(t => {
                    const isSel = this.selectedTagIds.includes(t.id);
                    const el = document.createElement('div'); el.className = `tag-chip ${isSel ? 'selected' : ''}`; el.style.backgroundColor = t.color; el.innerHTML = `${SecurityUtils.sanitizeText(t.name)} <span style="margin-left:5px;opacity:0.5;">‚úï</span>`;
                    el.querySelector('span').addEventListener('click', (ev) => this.deleteTag(ev, t.id));
                    el.addEventListener('click', (e) => { if(e.target.tagName === 'SPAN') return; const idx = this.selectedTagIds.indexOf(t.id); if (idx > -1) this.selectedTagIds.splice(idx, 1); else this.selectedTagIds.push(t.id); this.renderTagsSelection(); });
                    div.appendChild(el);
                });
                this.updateBorder();
            },
            updateBorder() { const tags = this.getTags(); const container = document.getElementById('tutorialInputContainer'); if (this.selectedTagIds.length > 0) { const first = tags.find(t => t.id === this.selectedTagIds[0]); if (first) container.style.borderLeftColor = first.color; } else { container.style.borderLeftColor = 'var(--accent)'; } },
            async add() {
                const title = document.getElementById('tutorialTitleInput').value.trim(); const content = document.getElementById('tutorialTextInput').innerHTML;
                if (!title) return alert("T√≠tulo obrigat√≥rio");
                const item = { id: this.editingId || Date.now(), title, content, tags: [...this.selectedTagIds], isPinned: false };
                if (this.editingId) { const all = await this.dbGetAll(); const old = all.find(x => x.id === this.editingId); if(old) item.isPinned = old.isPinned; }
                await this.dbSave(item); AppManager.showToast("Procedimento salvo!"); this.resetForm(); this.render();
            },
            resetForm() { this.editingId = null; this.selectedTagIds = []; document.getElementById('tutorialTitleInput').value = ''; document.getElementById('tutorialTextInput').innerHTML = ''; document.getElementById('tutorialSaveButton').textContent = "Salvar Procedimento"; this.renderTagsSelection(); },
            async edit(id) { const all = await this.dbGetAll(); const t = all.find(x => x.id === id); if (!t) return; this.editingId = id; document.getElementById('tutorialTitleInput').value = t.title; document.getElementById('tutorialTextInput').innerHTML = t.content; this.selectedTagIds = t.tags ? [...t.tags] : []; this.renderTagsSelection(); document.getElementById('tutorialSaveButton').textContent = "Atualizar Procedimento"; window.scrollTo({ top: 0, behavior: 'smooth' }); },
            async togglePin(e, id) { if(e && e.stopPropagation) e.stopPropagation(); const all = await this.dbGetAll(); const item = all.find(x => x.id === id); if (item) { item.isPinned = !item.isPinned; await this.dbSave(item); this.render(); } },
            async delete(e, id) { if(e && e.stopPropagation) e.stopPropagation(); if (!confirm("Excluir?")) return; const tx = this.db.transaction(CONFIG.DB_STORE, "readwrite"); tx.objectStore(CONFIG.DB_STORE).delete(id); tx.oncomplete = () => this.render(); },
            triggerImageUpload() { document.getElementById('imgUpload').click(); },
            handleImageUpload(input) { if (input.files[0]) { const r = new FileReader(); r.onload = e => this.insertImg(e.target.result); r.readAsDataURL(input.files[0]); } },
            triggerUrlImage() { const url = prompt("Link da imagem:"); if (url) this.insertImg(url); },
            insertImg(src) { document.execCommand('insertHTML', false, `<img src="${src}" loading="lazy" style="width:80%;display:block;margin:10px auto;" alt="Imagem do tutorial">`); },
            imgZoom(e) { if (e.target.tagName === 'IMG') { if (e.altKey) { const newW = prompt("Largura:", e.target.style.width); if (newW) e.target.style.width = newW; } else { document.getElementById('lightbox').classList.add('active'); document.getElementById('lightboxImg').src = e.target.src; } } },
            async render() {
                const grid = document.getElementById('tutorialGrid'); const term = document.getElementById('tutorialSearch').value.toLowerCase(); const allTags = this.getTags(); let data = await this.dbGetAll();
                if (term) data = data.filter(t => t.title.toLowerCase().includes(term) || t.content.toLowerCase().includes(term));
                data.sort((a, b) => (b.isPinned - a.isPinned) || (b.id - a.id));
                grid.innerHTML = '';
                if (data.length === 0) { grid.innerHTML = '<p style="text-align: center; opacity: 0.5;">Nenhum procedimento encontrado.</p>'; return; }
                data.forEach(t => {
                    const card = document.createElement('div'); card.className = `card-tutorial ${t.isPinned ? 'is-pinned' : ''}`;
                    let cardColor = 'var(--accent)'; let tagsHtml = '';
                    if (t.tags && t.tags.length > 0) { const first = allTags.find(x => x.id === t.tags[0]); if (first) cardColor = first.color; t.tags.forEach(tid => { const tag = allTags.find(x => x.id === tid); if (tag) tagsHtml += `<span class="card-tag-small" style="background:${tag.color}">${SecurityUtils.sanitizeText(tag.name)}</span>`; }); }
                    card.style.borderLeftColor = cardColor;
                    card.innerHTML = `<div class="card-header" onclick="this.parentElement.classList.toggle('open')"><div class="card-title-area"><h3 style="color: ${cardColor === 'var(--accent)' ? 'var(--primary)' : cardColor}">${SecurityUtils.sanitizeText(t.title)}</h3></div><div style="display:flex; align-items:center;"><div class="card-tags">${tagsHtml}</div><div class="card-options"><button class="btn-top-icon" onclick="TutorialsManager.togglePin(event, ${t.id})">üìå</button><button class="btn-top-icon" onclick="TutorialsManager.delete(event, ${t.id})">üóëÔ∏è</button></div></div></div><div class="card-body"><div class="card-content-inner" onclick="TutorialsManager.imgZoom(event)">${t.content}</div><div class="card-footer"><button class="btn-outline" onclick="TutorialsManager.edit(${t.id})">Editar</button></div></div>`;
                    grid.appendChild(card);
                });
            },
            async export() { const data = { tutorials: await this.dbGetAll(), tags: this.getTags() }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_tutoriais.json`; a.click(); },
            import(inp) { const r = new FileReader(); r.onload = async e => { try { const j = JSON.parse(e.target.result); if (j.tags) this.saveTags(j.tags); if (j.tutorials) for (const t of j.tutorials) await this.dbSave(t); this.render(); this.renderTagsSelection(); AppManager.showToast("Importado!"); } catch { alert("Erro arquivo."); } }; if(inp.files[0]) r.readAsText(inp.files[0]); }
        };

        const ReportsManager = {
            storageKey: 'noc_clients',
            currentSortMode: 'manual',
            legend: { 
                0: "OK", 1: "Backup com Sucesso Parcial", 2: "Backup avan√ßou a Janela", 
                3: "Problemas Espa√ßo no Destino", 4: "Falha de Energia / Ambiente", 5: "Falha na M√≠dia Destino", 
                6: "Falha no Disco Origem", 7: "Falha Interna de Software", 8: "Falha Desconhecida", 
                9: "Status Desconhecido", 10: "N√£o executa" 
            },
            init() { this.loadClients(); const today = new Date(); if (!document.getElementById('reportDateStart').value) document.getElementById('reportDateStart').valueAsDate = today; if (!document.getElementById('reportDateEnd').value) document.getElementById('reportDateEnd').valueAsDate = today; },
            getClients() { return JSON.parse(localStorage.getItem(this.storageKey)) || {}; },
            saveClients(clients) { localStorage.setItem(this.storageKey, JSON.stringify(clients)); },
            clearOutput() { document.getElementById('nocOutputArea').value = ""; },
            handleClientChange() { this.clearOutput(); this.loadRoutines(); },
            addClient() {
                const name = document.getElementById('nocNewClientName').value.trim();
                if (!name) return;
                const clients = this.getClients(); clients[name] = clients[name] || [];
                this.saveClients(clients); this.loadClients();
                document.getElementById('nocClientSelect').value = name; this.handleClientChange(); document.getElementById('nocNewClientName').value = '';
            },
            loadClients() {
                const clients = this.getClients(); const select = document.getElementById('nocClientSelect'); const currentVal = select.value;
                select.innerHTML = '<option value="" disabled selected>Selecione...</option>';
                for (let client in clients) { const option = document.createElement('option'); option.value = client; option.textContent = client; select.appendChild(option); }
                if(currentVal && clients[currentVal]) select.value = currentVal;
            },
            addRoutine() {
                const client = document.getElementById('nocClientSelect').value;
                if (!client) return alert("Selecione o cliente!");
                const num = document.getElementById('nocRoutineNum').value;
                const name = document.getElementById('nocRoutineName').value;
                if (!name) return;
                const clients = this.getClients(); clients[client].push({ num, name, id: Date.now() }); 
                this.saveClients(clients); this.loadRoutines();
                document.getElementById('nocRoutineNum').value = ''; document.getElementById('nocRoutineName').value = '';
            },
            editRoutine(id) {
                const client = document.getElementById('nocClientSelect').value; const clients = this.getClients();
                const r = clients[client].find(x => x.id === id); if(!r) return;
                const newNum = prompt("N¬∫:", r.num); const newName = prompt("Nome:", r.name);
                if (newName !== null) { r.num = newNum; r.name = newName; this.saveClients(clients); this.loadRoutines(); }
            },
            deleteRoutine(id) {
                if(!confirm("Apagar?")) return;
                const client = document.getElementById('nocClientSelect').value; const clients = this.getClients();
                clients[client] = clients[client].filter(r => r.id !== id);
                this.saveClients(clients); this.loadRoutines();
            },
            setSortMode(mode) {
                this.currentSortMode = mode;
                document.getElementById('btnSortManual').classList.toggle('active', mode === 'manual');
                document.getElementById('btnSortAlpha').classList.toggle('active', mode === 'alpha');
                this.loadRoutines();
            },
            loadRoutines() {
                const client = document.getElementById('nocClientSelect').value;
                if (!client) return;
                let routines = [...(this.getClients()[client] || [])];
                if (this.currentSortMode === 'alpha') routines.sort((a, b) => `${a.num} ${a.name}`.localeCompare(`${b.num} ${b.name}`));
                const listDiv = document.getElementById('nocSavedRoutinesList'); const entryArea = document.getElementById('nocDailyEntryArea');
                listDiv.innerHTML = ''; entryArea.innerHTML = `<h4 style="margin:0 0 10px 0; color:var(--text);">Cliente: ${client}</h4>`;
                routines.forEach((r, index) => {
                    const listItem = document.createElement('div'); listItem.className = 'noc-routine-item';
                    listItem.innerHTML = `<div style="flex:1;font-size:0.85em;"><b>${r.num ? r.num+' - ':''}</b>${r.name}</div><div><button class="btn-top-icon" onclick="ReportsManager.editRoutine(${r.id})">‚úé</button><button class="btn-top-icon" onclick="ReportsManager.deleteRoutine(${r.id})">‚úñ</button></div>`;
                    listDiv.appendChild(listItem);

                    const inputRow = document.createElement('div'); inputRow.className = `noc-routine-item status-0`; inputRow.id = `noc-row-${index}`;
                    inputRow.dataset.num = r.num || ''; inputRow.dataset.name = r.name;
                    inputRow.innerHTML = `<div style="flex:1;"><b>${r.num ? r.num+' - ':''}</b>${r.name}</div><input type="number" min="0" max="10" value="0" style="width:60px;margin:0;padding:5px;" id="noc-status-${index}" onchange="ReportsManager.updateRowColor(${index}, this.value)">`;
                    entryArea.appendChild(inputRow);
                });
            },
            updateRowColor(index, val) {
                const row = document.getElementById(`noc-row-${index}`);
                row.className = 'noc-routine-item';
                if (val == 0) row.classList.add('status-0');
                else if (val == 1) row.classList.add('status-1');
                else if (val == 10) row.classList.add('status-off');
                else row.classList.add('status-err');
            },
            formatDate(dateStr) { const [y, m, d] = dateStr.split('-'); return `${d}/${m}`; },
            generateReport() {
                const client = document.getElementById('nocClientSelect').value; const dateStart = document.getElementById('reportDateStart').value;
                if (!client || !dateStart) return alert("Verifique cliente/data!");
                const dateEnd = document.getElementById('reportDateEnd').value;
                let dateText = (!dateEnd || dateStart === dateEnd) ? `dia ${this.formatDate(dateStart)}` : `per√≠odo de ${this.formatDate(dateStart)} a ${this.formatDate(dateEnd)}`;
                let report = `Verifica√ß√£o dos Backups do ${dateText}:\n\n`;
                const rows = document.getElementById('nocDailyEntryArea').querySelectorAll('.noc-routine-item');
                rows.forEach((row, index) => {
                    if(!row.id) return; 
                    const num = row.dataset.num; const name = row.dataset.name; const statusVal = document.getElementById(`noc-status-${index}`).value;
                    let resultText = this.legend[statusVal] || "Desconhecido"; let extra = "";
                    if (statusVal == 10) { const m = prompt(`Rotina "${name}" n√£o executa quando?`, "s√°bado/domingo"); resultText = `N√£o executa ${m || ""}.`; }
                    else if (statusVal != 0) { const t = confirm(`Ticket para "${name}"?`) ? prompt("Ticket:") : ""; if (t) extra = ` (Ticket: ${t})`; }
                    report += `${num ? num+' - ':''}${name} = ${resultText}${extra}\n`;
                });
                document.getElementById('nocOutputArea').value = report.trim();
            },
            copyText() {
                const area = document.getElementById("nocOutputArea"); 
                area.value = area.value.trim(); // Garante que n√£o haja espa√ßos/linhas extras ao copiar
                area.select(); 
                document.execCommand("copy"); 
                AppManager.showToast("Relat√≥rio Copiado!");
            },
            enableEdit() { document.getElementById("nocOutputArea").readOnly = false; },
            exportData() { const blob = new Blob([localStorage.getItem(this.storageKey)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_noc.json`; a.click(); },
            importData(event) { const r = new FileReader(); r.onload = (e) => { localStorage.setItem(this.storageKey, e.target.result); this.loadClients(); AppManager.showToast("Importado!"); }; r.readAsText(event.target.files[0]); }
        };

        // Init
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { document.getElementById('tagModal').classList.remove('active'); document.getElementById('lightbox').classList.remove('active'); } });
        document.addEventListener('DOMContentLoaded', async () => {
            if (localStorage.getItem(CONFIG.STORAGE_KEY_DARK_MODE) === 'enabled') AppManager.toggleDarkMode();
            AppManager.loadBackground();
            await TutorialsManager.initDB();
            PromptsManager.render();
            TutorialsManager.renderTagsSelection();
            TutorialsManager.render();
            CommandsManager.render();
            
            // Listener para redimensionar imagens nos editores (clique)
            document.querySelectorAll('.rich-editor').forEach(editor => {
                editor.addEventListener('click', e => {
                    if (e.target.tagName === 'IMG') {
                        const currentW = e.target.style.width || "100%";
                        const newW = prompt("Redimensionar imagem - Digite a largura (ex: 50%, 100%, 400px):", currentW);
                        if (newW && SecurityUtils.isValidCSSValue(newW)) {
                            e.target.style.width = newW;
                            e.target.style.height = "auto";
                        }
                    }
                });
            });

            // Colar imagem
            document.querySelectorAll('.rich-editor').forEach(ed => {
                ed.addEventListener('paste', e => {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let i in items) {
                        if (items[i].kind === 'file') {
                            e.preventDefault();
                            const reader = new FileReader();
                            reader.onload = ev => document.execCommand('insertHTML', false, `<img src="${ev.target.result}" loading="lazy" style="width:100%;display:block;margin:10px auto;">`);
                            reader.readAsDataURL(items[i].getAsFile());
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
